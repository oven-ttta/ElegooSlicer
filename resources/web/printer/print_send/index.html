<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/light.css">

    <script src="../../include/jquery-3.6.0.min.js"></script>
    <script src="../thirdparty/vue/vue.global.prod.min.js"></script>
    <script src="../thirdparty/element-plus/index.full.min.js"></script> 
    <script src="../../include/json2.js"></script>
    <script src="../../include/globalapi.js"></script>
    <script src="../../data/text.js"></script>
    <script src="./img/filament.js"></script>
</head>
  
<body>
    <div id="app">
        <div class="print-task-dialog">
            <main class="print-task-content">
                <section class="model-section">
                    <img :src="modelImageSrc" class="model-preview" alt="3D Model">
                    
                    <div class="model-info">
                        <div class="model-name-edit">
                            <el-input 
                                v-model="printInfo.modelName" 
                                type="text" 
                                
                                @blur="stopEditing"
                                @keydown.enter="stopEditing"
                                @input="adjustModelNameWidth"
                                ref="modelNameInput"
                                id="model-name"
                                class="model-name-input"
                            ></el-input>
                            <button class="edit-name-btn" @click="startEditing">
                                <img src="img/edit.svg" alt=""/>
                            </button>
                        </div>
                        
                        <div class="print-stats">
                            <div class="stat-item">
                                <img class="stat-icon" src="img/clock.svg" alt="">
                                <span>{{ printInfo.printTime || '00:00:00' }}</span>
                            </div>
                            <div class="stat-item">
                                <img class="stat-icon" src="img/est-weight.svg" alt="">
                                <span>{{ formatWeight(printInfo.totalWeight) }}</span>
                            </div>
                            <div class="stat-item">
                                <img class="stat-icon" src="img/layer-num.svg" alt="">
                                <span>{{ printInfo.layerCount || 0 }}</span>
                            </div>
                        </div>
                        
                        <div class="device-selection">
                            <div class="section-header">
                                <label class="section-title">Printer</label>
                                <div class="section-separator"></div>
                            </div>
                            <div class="dropdowns-container">
                                <div class="dropdown" v-click-outside="closePrinterDropdown">
                                    <div 
                                        class="dropdown-header"
                                        :class="{ active: printerDropdownOpen }"
                                        @click="togglePrinterDropdown">
                                        <button 
                                            class="printer-refresh-btn" 
                                            @click.stop="refreshPrinterList">
                                            <img src="img/refresh.svg" alt="Refresh">
                                        </button>
                                        <img :src="curPrinter?.printerImg || ''" alt="" class="dropdown-icon">
                                        <div class="dropdown-content">
                                            <div class="dropdown-title">{{ curPrinter?.printerName || 'No printer' }}</div>
                                            <div class="dropdown-subtitle">{{ curPrinter?.printerModel || 'Please connect a printer' }}</div>
                                        </div>
                                    </div>
                                    <ul class="dropdown-menu" :hidden="!printerDropdownOpen">
                                        <li 
                                            v-for="printer in printerList" 
                                            :key="printer.printerId"
                                            class="dropdown-item"
                                            :class="{ selected: printer.printerId === curPrinter.printerId }"
                                            @click="selectPrinter(printer)">
                                            <img :src="printer.printerImg" alt="" class="dropdown-item-icon">
                                            <div class="dropdown-item-content">
                                                <div class="dropdown-item-title">{{ printer.printerName }}</div>
                                                <!-- <div v-if="printer.printerModel" class="dropdown-item-subtitle">{{ printer.printerModel }}</div> -->
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                
                                <div 
                                    class="dropdown bed-dropdown" 
                                    v-click-outside="closeBedDropdown"
                                    :class="{ hidden: !showBedDropdown }">
                                    <div 
                                        class="dropdown-header"
                                        :class="{ active: bedDropdownOpen }"
                                        @click="toggleBedDropdown">
                                        <img :src="selectedBedType.icon" alt="" class="dropdown-icon">
                                        <div class="dropdown-content">
                                            <div class="dropdown-title">{{ selectedBedType.name }}</div>
                                        </div>
                                    </div>
                                    <ul class="dropdown-menu" :hidden="!bedDropdownOpen">
                                        <li 
                                            v-for="bedType in bedTypes" 
                                            :key="bedType.value"
                                            class="dropdown-item"
                                            :class="{ selected: bedType.value === selectedBedType.value }"
                                            @click="selectBedType(bedType)">
                                            <img :src="bedType.icon" alt="" class="dropdown-item-icon">
                                            <div class="dropdown-item-content">
                                                <div class="dropdown-item-title">{{ bedType.name }}</div>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <section class="filament-section"  v-show="showFilamentSection">
                    <div class="filament-header">
                        <div class="filament-controls">
                            <div class="toggle-item">
                                <div class="toggle-label trans" tid="auto_refill">Auto Refill</div>
                                <label class="toggle-switch">
                                    <input type="checkbox" v-model="printInfo.autoRefill">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="filament-pagination">
                            <button class="pagination-btn" @click="prevPage" :disabled="currentPage <= 1">
                                <img src="img/prev.svg" alt="">
                            </button>
                            <span>{{ currentPage }}/{{ totalPages }}</span>
                            <button class="pagination-btn" @click="nextPage" :disabled="currentPage >= totalPages">
                                <img src="img/next.svg" alt="">
                            </button>
                        </div>
                    </div>
                    <div class="filament-list">
                        <div 
                            v-for="filament in currentPageFilaments" 
                            :key="filament.index"
                            class="mapping-container">
                            <div 
                                class="filament-rect" 
                                :style="getFilamentStyle(filament)"
                                :title="filament.filamentName">
                                <div class="filament-type">{{ filament.filamentType }}</div>
                                <div class="filament-weight">{{ formatWeight(filament.filamentWeight) }}</div>
                                </div>
                            <div 
                                class="tray-rect" 
                                :title="filament.mappedMmsFilament || 'No mapping'">
                                <span v-html="getFilamentSvg(filament.mappedMmsFilament)">
                                </span>
                                <div class="tray-filament-type">{{ filament.mappedMmsFilament?.filamentType || '?' }}</div>
                                  <el-popover
                                    ref="mmsPopover"
                                    placement="top"
                                    title=""    
                                    :width="352"
                                    trigger="click"
                                    :show-arrow="false"
                                >
                                  <template #default>
                                    <div>
                                        <div class="mms-header">
                                            <span class="mms-title" >"CANVAS"</span>
                                            <div style="border-bottom: 1px solid #DEDEDE; height: 1px; flex: 1;"></div>
                                        </div>
                                        <div class="mms-popover-content">
                                            <div 
                                                v-for="mms in printInfo.mmsInfo.mmsList" 
                                                :key="mms.mmsId"
                                                class="mms-row">
                                                <div class="tray-popover-content">
                                                    <div 
                                                        v-for="tray in mms.trayList" 
                                                        :key="tray.trayName"
                                                        class="tray-popover-card"
                                                        :style="getMmsCardStyle(tray)"
                                                        @click="updateFilamentMapping(filament.index, tray)">
                                                        <div class="tray-name">{{ tray.trayName }}</div>
                                                        <div class="tray-dash"></div>
                                                        <div class="tray-filament-type">{{ tray.filamentType }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                  </template>
                                    <template #reference>
                                            <span><img src="./img/down-arrow.svg" alt=""></span>
                                    </template>
                                </el-popover>
                          
                                <!-- <div class="tray-filament-type">{{ filament.amsFilamentType || 'N/A' }}</div> -->
                            </div>
                        </div>
                    </div>
                </section>

                <section class="options-section">
                    <div class="options-separator"></div>
                    
                    <div class="toggle-group">
                        <div class="toggle-item">
                            <div class="toggle-label trans" tid="switch_to_device_tab">Switch to Device Tab</div>
                            <label class="toggle-switch">
                                <input type="checkbox" v-model="printInfo.switchToDeviceTab">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-item">
                            <div class="toggle-label trans" tid="upload_and_print">Upload and Print</div>
                            <label class="toggle-switch">
                                <input type="checkbox" v-model="printInfo.uploadAndPrint">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </section>
                <section class="print-options-section" :class="{ hidden: !showPrintOptions }">
                    <div class="section-header">
                        <h3 class="section-title">Print Options</h3>
                        <div class="section-separator"></div>
                    </div>
                    
                    <div class="print-options-grid">
                        <div class="toggle-item">
                            <div class="toggle-label trans" tid="heated_bed_leveling">Auto Bed Leveling</div>
                            <label class="toggle-switch">
                                <input type="checkbox" v-model="printInfo.heatedBedLeveling">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="toggle-item">
                            <div class="toggle-label trans" tid="time_lapse">Timelapse</div>
                            <label class="toggle-switch">
                                <input type="checkbox" v-model="printInfo.timeLapse">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                </section>
            </main>
            
            <div class="status-tip" v-show="statusTip.show">{{ statusTip.message }}</div>
            
            <footer class="action-buttons">
                <button class="btn btn-secondary trans" @click="cancel" tid="cancel">Cancel</button>
                <button class="btn btn-primary trans" @click="upload" tid="upload">Upload</button>
            </footer>
        </div>
    </div>
    <script src="./printsend.js"></script>
</body>
</html>
